<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Obsidian+ — Programmable Productivity, Your Way</title>
  <meta name="description" content="A programmable Obsidian plugin that turns your vault into a living system. See live demos, real use cases, and grab a starter vault pre‑configured in minutes." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'><path fill='%235960f1' d='M128 10 30 74v108l98 64 98-64V74z'/></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <style>
    /*
      ==============================
      THEME LAYER — Obsidian-ish
      ==============================
      If you want this page to inherit your Obsidian theme, paste your theme's CSS variables
      here (usually found in .obsidian/themes/<Theme>.css), especially color tokens like:
      --background-primary, --background-secondary, --text-normal, --text-muted,
      --interactive-accent, --accent-strong, --background-modifier-border, etc.
      Keep the variable names below and override their values.
    */
    :root {
      /* Light defaults */
      --bg-primary: #f7f7f8;             /* ≈ background-primary */
      --bg-secondary: #ffffff;           /* ≈ background-secondary */
      --bg-elevated: #ffffffee;
      --text-normal: #1b1f23;            /* ≈ text-normal */
      --text-muted: #5f6b7a;             /* ≈ text-muted */
      --accent: #5960f1;                 /* ≈ interactive-accent */
      --accent-strong: #3b41dd;          /* ≈ accent-strong */
      --border: #e5e7eb;                 /* ≈ background-modifier-border */
      --callout-bg: #eef2ff;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger:  #ef4444;
      --shadow: 0 8px 28px rgba(0,0,0,.08);
      --radius-xl: 12px;
      --radius-lg: 8px;
      --radius-md: 6px;
      --content-max: 1080px;
      --font-sans: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, system-ui, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Dark mode (auto + toggle) */
    :root[data-theme="dark"] {
      --bg-primary: #121317;
      --bg-secondary: #171922;
      --bg-elevated: #171922ee;
      --text-normal: #e7eaf0;
      --text-muted: #a2a8b6;
      --accent: #7b7ffb;
      --accent-strong: #6366f1;
      --border: #262b35;
      --callout-bg: #1e2232;
      --shadow: 0 12px 36px rgba(0,0,0,.35);
    }

    /* Base */
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg-primary); color: var(--text-normal);
      font-family: var(--font-sans); line-height: 1.6; -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: var(--accent-strong); }
    .container { width: 100%; max-width: var(--content-max); margin: 0 auto; padding: 0 20px; }
    .btn { display: inline-flex; align-items: center; gap: 10px; padding: 12px 18px; border-radius: var(--radius-lg); border: 1px solid var(--border); background: var(--bg-secondary); box-shadow: var(--shadow); font-weight: 600; }
    .btn.primary { background: linear-gradient(180deg, var(--accent), var(--accent-strong)); color: white; border-color: transparent; }
    .btn.ghost { background: transparent; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-secondary); font-size: 12px; color: var(--text-muted); }
    .kbd { font-family: var(--font-mono); font-size: 12px; border: 1px solid var(--border); border-bottom-width: 3px; padding: 2px 6px; border-radius: 6px; background: var(--bg-secondary); }
    .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow); }
    .grid { display: grid; gap: 12px; }

    /* Nav */
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px); background: color-mix(in srgb, var(--bg-primary) 85%, transparent); border-bottom: 1px solid var(--border); }
    .hero .tagline { font-size: 24px; color: var(--accent); font-style: italic; }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 64px; }
    .logo { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .2px; }
    .logo svg { width: 24px; height: 24px; }
    .nav a { color: var(--text-muted); font-weight: 600; margin-left: 16px; }
    .nav a:hover { color: var(--text-normal); }

    /* Hero */
    .hero { padding: 72px 0 56px; position: relative; }
    .hero h1 { font-size: clamp(28px, 5vw, 44px); line-height: 1.1; margin: 0 0 14px; }
    .hero p { font-size: clamp(16px, 2.2vw, 18px); color: var(--text-muted); margin: 0 0 26px; }
    .hero .cta { display: flex; gap: 12px; flex-wrap: wrap; }
    .hero-visual { margin-top: 28px; border-radius: var(--radius-xl); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .hero-visual img { width: 100%; display: block; }

    /* Social proof */
    .proof { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 24px; }
    .proof .meter { padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-secondary); font-size: 14px; color: var(--text-muted); display:flex; align-items:center; gap:10px; }

    /* Sections */
    section { padding: 56px 0; }
    h2 { font-size: clamp(22px, 3.4vw, 32px); margin: 0 0 10px; }
    .sub { color: var(--text-muted); margin-top: 6px; }

    /* Features */
    .features { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .feature { padding: 18px; }
    .feature h3 { margin: 0 0 4px; font-size: 18px; }
    .feature p { margin: 0; color: var(--text-muted); }

    /* Demo */
    .demo-wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { padding: 12px; }
    .demo-controls .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .demo-controls label { font-size: 12px; color: var(--text-muted); display:block; margin-bottom:4px; }
    .demo-controls input, .demo-controls select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg-secondary); color: var(--text-normal);
      box-shadow: inset 0 1px 0 rgba(0,0,0,.02); }
    .note-tabs { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0px; }
    .note-tab { font-size:12px; padding:6px 10px; border:1px dashed var(--border); border-radius:var(--radius-md); background:transparent; cursor:pointer; color:var(--text-muted); }
    .note-tab.active, .note-tab:hover { border-color:var(--accent); color:var(--accent); }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 2px 10px; font-size: 14px; }
    th { font-weight: 700; }
    tr.item { cursor:pointer; }
    tr.item:hover { background: var(--bg-elevated); }
    tr.details { display:none; }
    tr.details.show { display:table-row; }
    tr.details ul { margin: 0; }
    .table-wrap + .table-wrap { margin-top:20px; }
    .table-wrap ul { list-style:none; padding-left:16px; }

    .dash-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      font-weight:700;
      margin:3px 8px;
    }
    .dash-header .arrow {
      transition:transform .2s;
      display:inline-block;
      transform:rotate(90deg);
    }
    .table-wrap.collapsed .dash-body { display:none; }
    .table-wrap.collapsed .dash-header .arrow { transform:rotate(0); }

    .dash-bullet {
      display:inline-block;
      width:6px; height:6px;
      border-radius:50%;
      margin-right:6px;
      background:var(--text-normal);
    }
    .dash-bullet.plus { background:#3b82f6; }
    .dash-bullet.star { background:#ef4444; }
    .dash-bullet.dash { background:var(--text-normal); }

    .item.plus, li.plus { color:#3b82f6; }
    .item.star, li.star { color:#ef4444; }
    .item.dash, li.dash { color:var(--text-normal); }
    .item.done, li.done,
    .item.cancelled, li.cancelled { opacity:0.6; }

    .table-wrap table { table-layout:fixed; width:100%; }
    .table-wrap td { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .table-wrap tr.item:hover td { white-space:normal; overflow:visible; }

    .feature ul { margin:0; padding-left:20px; }
    .feature ul li { margin-bottom:4px; }

    .badge {
      display:inline-block; color:#fff; padding:0px 5px; border-radius:10px; font-size:12px;
    }

    /* CodeMirror tweaks */
    .CodeMirror { height:100%; border:1px solid var(--border); border-radius: var(--radius-md); font-size:13px; background:var(--callout-bg); color:var(--text-normal); }
    .CodeMirror-lines { padding:10px; }
    .CodeMirror-cursor { border-left:1px solid var(--text-normal); }
    .cm-tag { color:#fff; border-radius:10px; padding:1px 5px; line-height: normal; display:inline-block; }

    /* .CodeMirror span { color:var(--text-normal); } */
    .cm-bullet-plus { color:#3b82f6 !important; }
    .cm-bullet-star { color:#ef4444 !important; }
    .cm-bullet-dash { color:var(--text-normal); }

    .chk {
      display:inline-block; width:16px; height:16px; border:1px solid var(--border); border-radius:4px; cursor:pointer; position:relative; vertical-align:middle;
    }
    .chk[data-state="done"]::after { content:'\2713'; position:absolute; top:-2px; left:2px; color:var(--success); font-size:14px; }
    .chk[data-state="cancelled"]::after { content:'\2717'; position:absolute; top:-2px; left:2px; color:var(--danger); font-size:14px; }

    #notePanel { display:flex; flex-direction:column; height:520px; }
    #previewPanel { height:540px; overflow:auto; }
    #editorWrap { flex:1; min-height:400px; }

    #notePreview {
      margin-top:8px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      background:var(--bg-secondary);
      max-height:200px;
      overflow:auto;
    }
    #notePreview h1 { font-size:18px; margin:6px 0; }
    #notePreview h2 { font-size:16px; margin:6px 0; }
    #notePreview img { max-width:100%; border-radius:var(--radius-md); }

    /* .rendered-note {  } */
    .card table { margin-bottom: 5px; }
    .note-list { list-style: disc; padding-left:20px; margin:0; }
    .note-list li { margin-bottom:4px; }
    .note-list .due { color: var(--text-muted); }
    .due { color: var(--text-muted); }

    /* Callouts */
    .callout { background: var(--callout-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 14px 16px; }

    /* Footer */
    footer { padding: 40px 0; border-top: 1px solid var(--border); color: var(--text-muted); }

    /* Responsive */
    @media (max-width: 960px) { .demo-wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="logo">
        <svg viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M128 10L30 74v108l98 64 98-64V74L128 10Z" fill="currentColor"/></svg>
        <span>Obsidian<span style="color:var(--accent)">+</span></span>
      </div>
      <nav>
        <a href="#story">Story</a>
        <a href="#systems">Systems</a>
        <a href="#demo">Live demo</a>
        <a href="#download">Download</a>
        <a id="themeToggle" class="pill" href="#">Toggle <span class="kbd">⌘/Ctrl</span> + <span class="kbd">D</span></a>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero">
      <div class="container">
        <span class="pill">Programmable plugin • No fluff, real workflows</span>
        <div class="title">
          <h1>From Notes to Systems — Instantly.</h1>
          <p class="tagline">Track projects, streamline SOPs, and automate your workflows - without setup.</p>
        </div>
        <p>I've used this setup for over a year to juggle research, product work, and family life. It can fire events, 
          run tasks, and call APIs directly from your notes, written in intuitive <strong>Markdown</strong> - putting the full power of no-code 
          tools at your fingertips, without clunky drag-and-drop interfaces. Track status of your team's work, send them tasks/tickets 
          to work on, and communicate with customers directly from your notebook. Receive payment notifications, status updates directly in your project, no context switch.</p>
        <div class="cta">
          <a href="#demo" class="btn primary">▶ Try the Live Demo</a>
          <a href="#download" class="btn">⬇ Get the Starter Vault</a>
          <a href="#systems" class="btn ghost">📚 Supported Systems</a>
        </div>
        <!-- <div class="proof">
          <div class="meter">⚡ Saves ~4–6 hrs/week</div>
          <div class="meter">🧩 Works with Dataview</div>
          <div class="meter">🛠️ Scriptable JS actions</div>
        </div> -->
        <div class="hero-visual card">
          <!-- Replace with your animated GIF or screenshot from your vault -->
          <!-- <img alt="Plugin screenshot" src="https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=1400&auto=format&fit=crop" /> -->
          <img alt="Plugin screenshot" src="./preview.png" />
        </div>
      </div>
    </section>

    <!-- STORY -->
    <section id="story">
      <div class="container">
        <h2>Why I built it</h2>
        <p class="sub">I needed one keyboard-driven place to capture ideas, triage tasks, and spin up repeatable workflows in seconds—without leaving my notes.</p>
        <div class="grid features" style="margin-top:18px;">
          <div class="feature card">
            <h3>Capture → Classify → Act</h3>
            <p>Turn scribbles into structured items with frontmatter autofill and smart templates. No more copy/paste gymnastics.</p>
          </div>
          <div class="feature card">
            <h3>Dataview superpowers</h3>
            <p>Use your existing metadata to render boards, tables, and rollups. Keep notes markdown‑pure; let the views do the heavy lifting.</p>
          </div>
          <div class="feature card">
            <h3>Programmable actions</h3>
            <p>Attach small JS snippets to commands: file ops, link graphs, recurring reviews, outbound webhooks, and more.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- SYSTEMS -->
    <section id="systems">
      <div class="container">
        <h2>Works with any system</h2>
        <p class="sub">GTD, EOS, or something uniquely yours — Obsidian+ adapts to whatever methodology drives you.</p>
        <div class="grid features" style="margin-top:18px;">
          <div class="feature card">
            <h3>Getting Things Done</h3>
            <ul>
              <li>Inbox capture</li>
              <li>Next actions & contexts</li>
              <li>Projects & weekly review</li>
            </ul>
          </div>
          <div class="feature card">
            <h3>EOS from Traction</h3>
            <ul>
              <li>Scorecards & Rocks</li>
              <li>Level 10 meetings</li>
              <li>Issues list & V/TO</li>
            </ul>
          </div>
          <div class="feature card">
            <h3>Your own system</h3>
            <p>Mix and match tags, fields, and automations to model any workflow you can imagine.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- LIVE DEMO (Dataview‑ish) -->
    <section id="demo">
      <div class="container">
        <h2>Live demo (notes → dashboards)</h2>
        <p class="sub">Type content in the left pane like you would in your notes. The right pane auto-generates dashboards based on a database built from your notes.</p>
    
        <div class="demo-wrap" style="align-items:start;">
          <!-- LEFT: Note editor -->
          <div id="notePanel" class="card panel">
            <div style="font-weight:700;">Notes (type here)</div>
            <div class="note-tabs">
              <button class="note-tab active" data-note="Daily Note">Daily Note</button>
              <button class="note-tab" data-note="Transaction Log">Transaction Log</button>
              <button class="note-tab" data-note="Project Note">Project Note</button>
            </div>
            <div id="editorWrap">
              <textarea id="noteInput" spellcheck="false"></textarea>
            </div>
            <div id="notePreview" class="rendered-note"></div>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-muted);margin-top:8px;">
              <input id="includePad" type="checkbox" checked style="accent-color:var(--accent);"> Add a few sample items from other notes (to simulate vault-wide rollups)
            </label>
            <!-- <div class="callout" style="margin-top:8px;">
              Tip: In your vault, the plugin reads actual notes (frontmatter + lines) and writes real views. This demo just shows the <em>feel</em> of the flow.
            </div> -->
          </div>

          <!-- RIGHT: Preview -->
          <div id="previewPanel" class="panel" style="padding:0;">
            <!-- <div style="font-weight:700; margin:12px;">Preview</div> -->
            <div id="viewContainer" class="rendered-note"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- DOWNLOAD -->
    <section id="download">
      <div class="container">
        <h2>Get the starter vault</h2>
        <p class="sub">Download a fresh Obsidian vault with the plugin pre‑configured, example notes, and ready‑made views.</p>
        <div class="card panel">
          <ol>
            <li><strong>Download:</strong> <a href="/downloads/obsidianplus-starter.zip">obsidianplus-starter.zip</a> (place the file in <code>~/Downloads</code> on your machine).</li>
            <li><strong>Open in Obsidian:</strong> Unzip → “Open folder as vault”.</li>
            <li><strong>Enable community plugins:</strong> Settings → Community Plugins → <em>On</em> → trust this vault.</li>
            <li><strong>Start:</strong> Open <code>📌 Start Here.md</code> for a 2‑minute tour.</li>
          </ol>
          <p class="sub">Note: Obsidian Publish doesn’t run community plugins. This site simulates outputs; the vault runs the real thing.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div style="display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:center;">
        <div>© <span id="year"></span> Obsidian+. Built with plain HTML+JS. No tracking by default.</div>
        <div><a href="#" id="copyThemeBtn" class="pill">How to use my Obsidian theme →</a></div>
      </div>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/markdown/markdown.min.js"></script> -->
  <script>
    // === Dark mode: auto + toggle + persisted ===
    (function() {
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.dataset.theme = saved || (prefersDark ? 'dark' : 'light');
      const t = document.getElementById('themeToggle');
      if (t) t.addEventListener('click', (e) => { e.preventDefault(); toggleTheme(); });
      function toggleTheme(){ root.dataset.theme = root.dataset.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('theme', root.dataset.theme); }
      window.addEventListener('keydown', (ev) => { if ((ev.metaKey || ev.ctrlKey) && ev.key.toLowerCase() === 'd') { toggleTheme(); ev.preventDefault(); } });
    })();
    
    // === Elements ===
    const includePadEl = document.getElementById('includePad');
    const containerEl = document.getElementById('viewContainer');
    const cm = CodeMirror.fromTextArea(document.getElementById('noteInput'), {
      lineNumbers: false,
      lineWrapping: true, 
      mode: null
    });
    cm.addOverlay({
      token: function(stream) {
        if (stream.sol()) {
          stream.eatSpace();
          const ch = stream.peek();
          if (ch === '+' || ch === '-' || ch === '*') {
            stream.next();
            return ch === '+' ? 'bullet-plus' : (ch === '*' ? 'bullet-star' : 'bullet-dash');
          }
        }
        if (stream.match(/#[A-Za-z0-9_-]+/)) return 'tag';
        // while (stream.next() != null && !stream.match(/#[A-Za-z0-9_-]+/, false)) {}
        stream.next();
        return null;
      }
    });
    cm.on('change', ()=>requestAnimationFrame(render));
    
    // === Notes ===
    const NOTES = {
      'Daily Note':
`Dump anything that comes to mind into your daily notes, all information will self-organize into a database:
- 15 Boardwalk: guest-reported issues
	- [ ] #todo check leak under fridge
		- guest says they saw a small puddle
	- [ ] #todo restock coffee and paper towels

- [ ] #todo 5 Bow St: replace smoke detectors
	- had false alarm recently
	- they're ~8 years old now, time to update

Personal assistant directly in your notebook that pulls the context from your notes:
- I need to estimate construction costs for a 2000 sqft house in 02465 zip
	- [x] #chatgpt can you ballpark this? ✅ 2025-08-17✓✓
	    + Construction costs for a 2000 sqft house in zip code 02465 (Newton, MA) can range **$400,000–$800,000+** depending on finishes and labor.
	        + Low-end: Basic finishes, modular/prefab (~$200/sqft)
	        + Mid-range: Custom build with standard materials (~$300–$400/sqft)
	        + High-end: Luxury finishes, complex design (~$400+/sqft)
	    + Factors impacting cost:
	        + Land/prep (steep lots or rocky soil increase expenses)
	        + Local permitting fees and labor rates (Boston area is ~20% above national avg)
	        + Material choices (e.g., hardwood vs. laminate)
	    + Verify with local contractors for precise bids.

Document music that helps you focus:
- #music Midnight Flow Music — Night Bass
	- https://www.youtube.com/watch?v=AVmyklX6LEA
	- calm, focus
	- ![[music_screenshot1.png]]`,

      'Transaction Log':
`Transaction logs are auto-populated from external APIs + IoT devices. They're color-coded to avoid confusion with your personal notes:
- your notes are white
+ responses from outside APIs are blue
* errors are red

+ #check-in 15 Boardwalk: Matt Smith ⏳ 2025-08-17 
	+ contact info: 617-123-4567
	+ check-out: [[2025-08-19]]
+ #payment Jordan Perkins: $2000 (Gmail sync)
+ #payment Maryann Cooper: $1385 (Plaid sync)
	-  said she will Zelle the rest by Monday
		- [ ] #todo ping about remaining payment
+ #iot 5 Bow St: abnormal moisture levels under kitchen sink
        - [ ] #todo check kitchen sink for leaks
+ #iot 16 Pearl St: abnormally high electric usage (60kWh/day)
        - probably AC
* #iot 5 Bow St: lightbulb offline (rear hallway)
+ #iot 22 Oak Ridge: basement humidity 80%
        - [ ] #todo inspect dehumidifier
+ #iot 10 Market St: front door left ajar
        - [ ] #todo contact security`,

      'Project Note':

`# 41 Main St Rehab
This page is dedicated to a specific project, it's not part of the daily notes. The content can be in whatever format you want, only tags you assign meaning to get interpreted.

- 41 Main St Rehab:
  - [x] #todo apply for sprinkler permits ✅ 2025-08-10
  - [ ] #todo run electrical
  - [x] #pay $3500 (Mario - plumbing) ✅ 2025-08-17
  - [ ] #urgent extend building permit`,

      'Music Library':
  `- #music Hypermind Music — Limitless Productivity Playlist
        - https://www.youtube.com/watch?v=4MFOBeUCPkw
        - coding, focus, chill
        - ![[music_screenshot2.png]]
  - #music Night at Work | Instrumental Chill Music Mix
        - https://www.youtube.com/watch?v=n9Y2Eb4BaSg
        - optimistic, calm, focus
        - ~8min: Audial - Silhouette
        - ![[music_screenshot3.png]]
  - #music Deadline Mode • Focus Beats to Crush Your To-Do List | Chillstep Mix
        - https://www.youtube.com/watch?v=lwXCyKI845E
        - relaxing, focus, ambient
        - ![[music_screenshot4.png]]`
    };
    let currentNote = 'Daily Note';
    const noteTabs = document.querySelectorAll('.note-tab');

    function parseTree(text){
      const root = [];
      const stack = [{ indent:-1, children:root }];
      const lines = (text||'').split(/\r?\n/);
      lines.forEach((line, idx)=>{
        if(!line.trim()) return;
        const indent = line.match(/^\s*/)[0].length;
        const clean = line.trim();
        const bulletChar = /^[-+*]/.test(clean) ? clean.charAt(0) : '';
        const statusChar = (clean.match(/^[-+*]\s*\[( |x|-)\]/i)||[])[1] || ' ';
        const status = statusChar === 'x' ? 'done' : statusChar === '-' ? 'cancelled' : 'open';
        const tags = Array.from(clean.matchAll(/#([A-Za-z0-9_-]+)/g)).map(m=>m[1].toLowerCase());
        const due = (clean.match(/(?:\ud83d\udcc5|✅|❌|⏳)\s*(202[4-9]-[01]\d-[0-3]\d)/)||[])[1]
          || (clean.match(/\[\[(202[4-9]-[01]\d-[0-3]\d)\]\]/)||[])[1]
          || (clean.match(/\b(202[4-9]-[01]\d-[0-3]\d)\b/)||[])[1]
          || '';
        const url = (clean.match(/https?:\/\/\S+/)||[])[0] || '';
        const textContent = clean
          .replace(/^[-+*]\s*\[(?:x|\s|-)\]\s*/i,'')
          .replace(/^[-+*]\s*/,'')
          .replace(/#[A-Za-z0-9_-]+/g,'')
          .replace(/(?:\ud83d\udcc5|✅|❌|⏳)\s*[0-9\/\-]+/g,'')
          .replace(/\[\[202[4-9]-[01]\d-[0-3]\d\]\]/g,'')
          .replace(url,'')
          .replace(/\s{2,}/g,' ').trim();
        const node = { bullet:bulletChar, text:textContent, tags, due, url, status, line:idx, children:[] };
        while(stack.length && indent <= stack[stack.length-1].indent) stack.pop();
        stack[stack.length-1].children.push(node);
        stack.push({ indent, children: node.children });
      });
      return root;
    }

    function collectFromNote(name, text){
      const out = [];
      function walk(nodes, ctx){
        nodes.forEach(n=>{
          const nextCtx = n.text.includes(':') ? n.text.split(':')[0].trim() : ctx;
          const children = n.children.filter(c=>!c.tags.length);
          let title = n.text;
          if(ctx && n.tags.some(t=>t==='todo' || t==='urgent')){
            title = `${ctx}: ${title}`;
          }
          if(n.tags.length){
            out.push({
              title,
              tags:n.tags,
              due:n.due,
              url:n.url,
              status:n.status,
              line:n.line,
              bullet:n.bullet,
              view:n.tags.includes('music') ? 'music' : (n.tags.includes('iot') ? 'monitoring' : (n.tags.some(t=>t==='payment' || t==='pay') ? 'payment' : 'task')),
              source:name,
              children
            });
          }
          if(n.children.length) walk(n.children, nextCtx);
        });
      }
      walk(parseTree(text), '');
      return out;
    }

    function currentItems(){
      const items = Object.keys(NOTES).flatMap(n=>collectFromNote(n, n===currentNote ? cm.getValue() : NOTES[n]));
      return items;
    }

    const TAG_COLORS = {
      todo:   { bg:'#4b5563', fg:'#ffffff' },
      urgent: { bg:'#ef4444', fg:'#ffffff' },
      music:  { bg:'#6366f1', fg:'#ffffff' },
      payment:{ bg:'#10b981', fg:'#ffffff' },
      pay:    { bg:'#10b981', fg:'#ffffff' },
      'check-in':{ bg:'#0ea5e9', fg:'#ffffff' },
      iot:    { bg:'#0ea5e9', fg:'#ffffff' },
      chatgpt:{ bg:'#8b5cf6', fg:'#ffffff' }
    };

    function tagStyles(str){
      return TAG_COLORS[str] || { bg:'#94a3b8', fg:'#ffffff' };
    }

    function badge(tag){
      const clean = tag.replace('#','');
      const {bg,fg} = tagStyles(clean);
      return `<span class="badge" style="background:${bg};color:${fg};">${tag}</span>`;
    }

    function tableHTML(title, items){
      if(!items.length) return '';
      return `<div class="card table-wrap"><div class="dash-header">${title}<span class="arrow">›</span></div><div class="dash-body"><table><tbody>${
        items.map(i=>`<tr class="item ${bulletClass(i.bullet)}${i.status==='done'?' done':''}${i.status==='cancelled'?' cancelled':''}" data-note="${i.source}"><td>${renderMainLine(i)}</td></tr>${i.children.length?`<tr class="details"><td><ul>${i.children.map(renderChildLine).join('')}</ul></td></tr>`:''}`).join('')
      }</tbody></table></div></div>`;
    }

    function styleEditorTags(){
      const tags = cm.getWrapperElement().querySelectorAll('.cm-tag');
      tags.forEach(el=>{
        const clean = el.textContent.replace('#','');
        const {bg,fg} = tagStyles(clean);
        el.style.background = bg;
        el.style.color = fg;
      });
    }

    function styleBulletLines(){
      cm.eachLine(line=>{
        cm.removeLineClass(line, 'text', 'cm-bullet-plus');
        cm.removeLineClass(line, 'text', 'cm-bullet-star');
        cm.removeLineClass(line, 'text', 'cm-bullet-dash');
        const text = line.text.trimStart();
        if (text.startsWith('+')) cm.addLineClass(line, 'text', 'cm-bullet-plus');
        else if (text.startsWith('*')) cm.addLineClass(line, 'text', 'cm-bullet-star');
        else if (text.startsWith('-')) cm.addLineClass(line, 'text', 'cm-bullet-dash');
      });
    }

    function styleEditorBullets(){
      const bullets = cm.getWrapperElement().querySelectorAll('.cm-formatting-list');
      bullets.forEach(el=>{
        const ch = el.textContent.trim().charAt(0);
        if(ch === '+') el.style.color = '#3b82f6';
        else if(ch === '*') el.style.color = '#ef4444';
        else el.style.color = 'var(--text-normal)';
      });
    }

    function matchHeights(){
      const editorWrap = document.getElementById('editorWrap');
      if(editorWrap) cm.setSize(null, editorWrap.clientHeight);
    }
    function renderNotePreview(){
      const preview = document.getElementById('notePreview');
      if(!preview) return;
      const text = cm.getValue();
      const html = text.split(/\r?\n/).map(line=>{
        const trimmed = line.trim();
        if(/^!\[\[(.+?)\]\]/.test(trimmed)){
          const img = RegExp.$1;
          return `<img src="${img}" alt="${img}" style="max-width:100%;">`;
        }else if(/^(#{1,6})\s+(.*)/.test(trimmed)){
          const lvl = RegExp.$1.length;
          const content = RegExp.$2;
          return `<h${lvl}>${content}</h${lvl}>`;
        }else if(trimmed){
          return `<p>${trimmed}</p>`;
        }
        return '';
      }).join('');
      preview.innerHTML = html;
    }

    function render(){
      if(!containerEl) return;
      renderNotePreview();
      const items = currentItems();
      const todos = items.filter(i=>i.view === 'task' && i.tags.some(t=>t==='todo' || t==='urgent'));
      const payments = items.filter(i=>i.view === 'payment');
      const music = items.filter(i=>i.view === 'music');
      const monitoring = items.filter(i=>i.view === 'monitoring');
      containerEl.innerHTML = tableHTML('Todos', todos) + tableHTML('Payments', payments) + tableHTML('Music', music) + tableHTML('Monitoring', monitoring);
      const wraps = containerEl.querySelectorAll('.table-wrap');
      wraps.forEach(wrap=>{
        const header = wrap.querySelector('.dash-header');
        header.addEventListener('click',()=>wrap.classList.toggle('collapsed'));
        const title = header.textContent.trim();
        if(title==='Todos' || title==='Music') wrap.classList.add('collapsed');
      });
      containerEl.querySelectorAll('tr.item').forEach(row=>{
        row.addEventListener('click',()=>{
          const next = row.nextElementSibling;
          if(next) next.classList.toggle('show');
        });
      });
      containerEl.querySelectorAll('.note-link').forEach(a=>{
        a.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); loadNote(a.dataset.note); });
      });
      containerEl.querySelectorAll('.chk').forEach(cb=>{
        cb.addEventListener('click',e=>{
          e.stopPropagation();
          const note = cb.dataset.note;
          const line = Number(cb.dataset.line);
          const state = cb.dataset.state;
          const next = state==='open'?'done':(state==='done'?'cancelled':'open');
          updateLineState(note, line, next);
          render();
        });
      });
      styleEditorTags();
      styleBulletLines();
      matchHeights();
    }

    if(includePadEl) includePadEl.addEventListener('input', render);

    function loadNote(name){
      currentNote = name;
      noteTabs.forEach(b=>b.classList.toggle('active', b.dataset.note===name));
      cm.setValue(NOTES[name]||'');
      requestAnimationFrame(render);
    }

    noteTabs.forEach(btn=>btn.addEventListener('click',()=>loadNote(btn.dataset.note)));

    function updateLineState(note, line, state){
      const apply = (lines)=>{
        if(line < lines.length){
          lines[line] = setLineState(lines[line], state);
        }
      };
      if(note===currentNote){
        const lineText = cm.getLine(line);
        const newLine = setLineState(lineText, state);
        cm.replaceRange(newLine, {line, ch:0}, {line, ch:lineText.length});
      }else{
        const lines = (NOTES[note]||'').split(/\r?\n/);
        apply(lines);
        NOTES[note] = lines.join('\n');
      }
    }

    function setLineState(text, state){
      const now = new Date().toISOString().slice(0,10);
      let newText = text.replace(/\[( |x|-)\]/, state==='done'?'[x]':state==='cancelled'?'[-]':'[ ]');
      newText = newText.replace(/\s*(✅|❌)\s*202[4-9]-[01]\d-[0-3]\d/, '');
      if(state==='done') newText = newText.trimEnd()+` ✅ ${now}`;
      else if(state==='cancelled') newText = newText.trimEnd()+` ❌ ${now}`;
      return newText;
    }

    function bulletClass(ch){
      return ch === '+' ? 'plus' : (ch === '*' ? 'star' : 'dash');
    }

    function renderMainLine(i){
      const bullet = i.view === 'task' ? '' : `<span class="dash-bullet ${bulletClass(i.bullet)}"></span>`;
      const checkbox = i.view === 'task' ? `<span class="chk" data-note="${i.source}" data-line="${i.line}" data-state="${i.status}"></span> ` : '';
      const tags = i.tags.map(t=>badge('#'+t)).join(' ');
      const statusIcon = i.status==='done' ? '✅' : (i.status==='cancelled' ? '❌' : '');
      const due = i.due?` <span class="due">${statusIcon} ${i.due}</span>`:'';
      const link = `<a href="#" class="note-link" data-note="${i.source}">${i.source}</a>`;
      const url = i.url?` <a href="${i.url}" target="_blank">${i.url}</a>`:'';
      return `${bullet}${checkbox}${tags} ${i.title}${due} ${link}${url}`;
    }

    function renderChildLine(c){
      if(/^!\[\[(.+?)\]\]/.test(c.text)){
        const img = RegExp.$1;
        return `<li><img src="${img}" alt="${img}" style="max-width:100%;"></li>`;
      }
      const bullet = `<span class="dash-bullet ${bulletClass(c.bullet)}"></span>`;
      const tags = c.tags.map(t=>badge('#'+t)).join(' ');
      const due = c.due?` <span class="due">${c.due}</span>`:'';
      const url = c.url?` <a href="${c.url}" target="_blank">${c.url}</a>`:'';
      return `<li class="${bulletClass(c.bullet)}${c.status==='done'?' done':''}${c.status==='cancelled'?' cancelled':''}">${bullet}${tags} ${c.text}${due}${url}</li>`;
    }

    // Footer year + theme how-to
    const yearEl = document.getElementById('year'); if(yearEl) yearEl.textContent = new Date().getFullYear();
    const themeBtn = document.getElementById('copyThemeBtn'); if(themeBtn) themeBtn.addEventListener('click', (e)=>{ e.preventDefault(); alert(`To inherit your Obsidian theme:\n\n1) Open .obsidian/themes/<YourTheme>.css\n2) Copy the CSS variable block (e.g. :root { --background-primary: ... })\n3) Paste into this file's :root and :root[data-theme="dark"] sections.\n4) Save and refresh.`); });
    
    // Initial render
    loadNote(currentNote);
    </script>    
</body>
</html>

